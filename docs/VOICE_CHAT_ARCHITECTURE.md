# 🎤 Архитектура голосового чата

## Обзор

Голосовой чат в Protocol TX использует **WebRTC (Web Real-Time Communication)** для прямого peer-to-peer соединения между игроками. Это позволяет передавать аудио с минимальной задержкой без нагрузки на игровой сервер.

## 📊 Схема работы

### Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    ГОЛОСОВОЙ ЧАТ - АРХИТЕКТУРА                   │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   ИГРОК 1    │         │   ИГРОК 2    │         │   ИГРОК 3    │
│  (Клиент)    │         │  (Клиент)    │         │  (Клиент)    │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │  WebSocket (сигналинг) │                        │
       │  ──────────────────────┼────────────────────────┤
       │                        │                        │
       ▼                        ▼                        ▼
┌──────────────────────────────────────────────────────────────┐
│              ИГРОВОЙ СЕРВЕР (WebSocket)                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Сигналинг (обмен SDP и ICE кандидатами)             │   │
│  │  - voice_join    → уведомление о входе                │   │
│  │  - voice_offer   → предложение соединения            │   │
│  │  - voice_answer  → ответ на предложение              │   │
│  │  - voice_ice_candidate → сетевые адреса              │   │
│  └──────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
       │                        │                        │
       │  WebRTC (P2P аудио)    │                        │
       │  ──────────────────────┼────────────────────────┤
       │                        │                        │
       ▼                        ▼                        ▼
┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   ИГРОК 1    │◄───────►│   ИГРОК 2    │◄───────►│   ИГРОК 3    │
│  (P2P аудио) │         │  (P2P аудио) │         │  (P2P аудио) │
└──────────────┘         └──────────────┘         └──────────────┘
```

### Детальная схема установки соединения

```
┌─────────────────────────────────────────────────────────────────┐
│           ПРОЦЕСС УСТАНОВКИ ГОЛОСОВОГО СОЕДИНЕНИЯ              │
└─────────────────────────────────────────────────────────────────┘

ШАГ 1: ИНИЦИАЛИЗАЦИЯ
─────────────────────
Игрок 1 входит в комнату
    │
    ├─► MultiplayerManager.onRoomJoined()
    │       │
    │       └─► getVoiceChatManager().initialize(roomId, playerId)
    │               │
    │               ├─► Запрос микрофона: getUserMedia()
    │               │       │
    │               │       └─► MediaStream (локальный аудио)
    │               │
    │               └─► Отправка voice_join → Сервер
    │
    └─► Сервер рассылает VOICE_PLAYER_JOINED всем в комнате


ШАГ 2: СОЗДАНИЕ СОЕДИНЕНИЯ
───────────────────────────
Игрок 2 получает VOICE_PLAYER_JOINED
    │
    └─► VoiceChatManager.createPeerConnection(Игрок 1)
            │
            ├─► Создание RTCPeerConnection
            │       │
            │       ├─► Добавление локального потока (addTrack)
            │       │
            │       ├─► Настройка обработчиков:
            │       │       ├─► ontrack → получение удаленного аудио
            │       │       └─► onicecandidate → сбор сетевых адресов
            │       │
            │       └─► Создание Offer (SDP)
            │
            └─► Отправка voice_offer → Сервер → Игрок 1


ШАГ 3: ОБМЕН SDP (Session Description Protocol)
─────────────────────────────────────────────────
Игрок 1 получает voice_offer
    │
    └─► VoiceChatManager.handleOffer()
            │
            ├─► Создание RTCPeerConnection (если еще нет)
            │
            ├─► setRemoteDescription(offer)
            │
            ├─► Создание Answer (SDP)
            │
            └─► Отправка voice_answer → Сервер → Игрок 2

Игрок 2 получает voice_answer
    │
    └─► VoiceChatManager.handleAnswer()
            │
            └─► setRemoteDescription(answer)


ШАГ 4: ICE (Interactive Connectivity Establishment)
─────────────────────────────────────────────────────
Оба игрока собирают сетевые адреса
    │
    ├─► Игрок 1: onicecandidate срабатывает
    │       │
    │       └─► Отправка voice_ice_candidate → Сервер → Игрок 2
    │
    └─► Игрок 2: onicecandidate срабатывает
            │
            └─► Отправка voice_ice_candidate → Сервер → Игрок 1

Оба игрока получают ICE кандидаты
    │
    ├─► Игрок 1: addIceCandidate(candidate от Игрока 2)
    │
    └─► Игрок 2: addIceCandidate(candidate от Игрока 1)


ШАГ 5: УСТАНОВЛЕНИЕ P2P СОЕДИНЕНИЯ
───────────────────────────────────
ICE находит оптимальный путь
    │
    ├─► Прямое соединение (если возможно)
    │       │
    │       └─► Игрок 1 ←→ Игрок 2 (напрямую)
    │
    └─► Через STUN/TURN (если NAT блокирует)
            │
            └─► Игрок 1 → STUN → Игрок 2


ШАГ 6: ПЕРЕДАЧА АУДИО
─────────────────────
Соединение установлено
    │
    ├─► Игрок 1: ontrack срабатывает
    │       │
    │       └─► handleRemoteStream(Игрок 2, stream)
    │               │
    │               ├─► Создание HTMLAudioElement
    │               │
    │               └─► Воспроизведение удаленного аудио
    │
    └─► Игрок 2: ontrack срабатывает
            │
            └─► handleRemoteStream(Игрок 1, stream)
                    │
                    ├─► Создание HTMLAudioElement
                    │
                    └─► Воспроизведение удаленного аудио

✅ ГОЛОСОВОЙ ЧАТ АКТИВЕН
```

## 🔄 Процесс установки соединения

### Этап 1: Инициализация
```
Игрок входит в комнату
    ↓
MultiplayerManager → getVoiceChatManager().initialize(roomId, playerId)
    ↓
VoiceChatManager запрашивает доступ к микрофону
    ↓
navigator.mediaDevices.getUserMedia({ audio: {...} })
    ↓
Получен MediaStream (локальный аудиопоток)
    ↓
Отправка voice_join через WebSocket сервер
```

### Этап 2: Обнаружение других игроков
```
Сервер получает voice_join от Игрока 1
    ↓
Сервер рассылает VOICE_PLAYER_JOINED всем в комнате
    ↓
Игрок 2 получает уведомление о новом игроке
    ↓
VoiceChatManager.createPeerConnection(remotePlayerId)
```

### Этап 3: WebRTC Handshake (Offer/Answer)
```
Игрок 1 создает RTCPeerConnection
    ↓
Создает Offer (SDP - Session Description Protocol)
    ↓
Отправляет voice_offer через сервер → Игрок 2
    ↓
Игрок 2 получает Offer
    ↓
Создает Answer (SDP)
    ↓
Отправляет voice_answer через сервер → Игрок 1
```

### Этап 4: ICE (Interactive Connectivity Establishment)
```
Оба игрока собирают сетевые адреса (ICE кандидаты)
    ↓
Отправляют voice_ice_candidate через сервер
    ↓
Устанавливается прямое P2P соединение
    ↓
Аудио начинает передаваться напрямую (минуя сервер)
```

## 📦 Компоненты системы

### 1. VoiceChatManager (`src/client/voiceChat.ts`)

**Основные свойства:**
- `localStream: MediaStream` - локальный аудиопоток с микрофона
- `peers: Map<string, RTCPeerConnection>` - соединения с другими игроками
- `audioElements: Map<string, HTMLAudioElement>` - элементы для воспроизведения удаленного аудио
- `config: VoiceChatConfig` - настройки (громкость, push-to-talk, mute)

**Ключевые методы:**
- `initialize()` - инициализация, запрос микрофона
- `createPeerConnection()` - создание WebRTC соединения
- `handleOffer()` - обработка входящего предложения
- `handleAnswer()` - обработка ответа
- `handleIceCandidate()` - обработка сетевых адресов
- `handleRemoteStream()` - обработка входящего аудиопотока

### 2. MultiplayerManager (`src/client/multiplayer.ts`)

**Интеграция:**
- Инициализирует VoiceChatManager при входе в комнату
- Маршрутизирует голосовые сообщения от сервера
- Предоставляет callback для отправки сообщений

### 3. GameServer (`src/server/gameServer.ts`)

**Обработка сигналинга:**
- Принимает голосовые сообщения от клиентов
- Перенаправляет их другим игрокам в комнате
- Не обрабатывает аудио (только сигналинг)

## 🔧 Технические детали

### WebRTC Конфигурация

```typescript
new RTCPeerConnection({
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" }
    ]
})
```

**STUN серверы** используются для определения публичных IP-адресов игроков через NAT.

### Аудио настройки

```typescript
navigator.mediaDevices.getUserMedia({
    audio: {
        echoCancellation: true,    // Подавление эха
        noiseSuppression: true,     // Подавление шума
        autoGainControl: true,      // Автоматическая регулировка громкости
        sampleRate: 48000          // Частота дискретизации
    }
})
```

### Режимы работы

1. **Always-on (постоянно включен)**
   - Микрофон активен всегда (кроме mute)
   - Браузер сам определяет активность голоса

2. **Push-to-talk (нажал и говори)**
   - Микрофон активен только при удержании клавиши (по умолчанию V)
   - Управляется через `setPushToTalkActive()`

## 📡 Типы сообщений

### Клиент → Сервер → Клиент

1. **voice_join**
   ```typescript
   {
       type: "voice_join",
       roomId: string,
       playerId: string
   }
   ```
   - Отправляется при инициализации
   - Сервер уведомляет других игроков

2. **voice_offer**
   ```typescript
   {
       type: "voice_offer",
       to: string,           // ID получателя
       offer: RTCSessionDescriptionInit
   }
   ```
   - Предложение соединения (SDP)

3. **voice_answer**
   ```typescript
   {
       type: "voice_answer",
       to: string,
       answer: RTCSessionDescriptionInit
   }
   ```
   - Ответ на предложение (SDP)

4. **voice_ice_candidate**
   ```typescript
   {
       type: "voice_ice_candidate",
       to: string,
       candidate: RTCIceCandidateInit
   }
   ```
   - Сетевой адрес для P2P соединения

## 🎯 Преимущества архитектуры

1. **Низкая задержка** - прямое P2P соединение
2. **Масштабируемость** - сервер не обрабатывает аудио
3. **Качество** - WebRTC оптимизирован для реального времени
4. **Безопасность** - шифрование встроено в WebRTC

## ⚠️ Ограничения

1. **NAT/Firewall** - может потребоваться TURN сервер для сложных сетей
2. **Браузерные ограничения** - требуется разрешение на микрофон
3. **Множественные соединения** - каждому игроку нужно соединение с каждым (O(n²))

## 🔍 Отладка

**Проверка соединений:**
```typescript
const manager = getVoiceChatManager();
console.log("Enabled:", manager.isEnabled());
console.log("Talking:", manager.isTalkingNow());
console.log("Config:", manager.getConfig());
```

**Логи:**
- Все события логируются через `logger` с категорией `[VoiceChat]`
- Ошибки доступа к микрофону обрабатываются с понятными сообщениями

## 📝 Будущие улучшения

1. **TURN сервер** - для обхода сложных NAT
2. **3D позиционный звук** - интеграция с SoundManager
3. **Групповые комнаты** - оптимизация для больших групп
4. **Шифрование** - дополнительное шифрование поверх WebRTC

