# Диаграммы архитектуры Protocol TX

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                        Browser                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Protocol TX Client                      │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │              Game (Orchestrator)             │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │  Tank    │  │  Enemy   │  │  Chunk  │   │   │   │
│  │  │  │Controller│  │ Manager  │  │ System  │   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │   HUD    │  │  Sound   │  │ Effects │   │   │   │
│  │  │  │          │  │ Manager  │  │ Manager │   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │         Babylon.js Engine                    │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │  Scene  │  │  Camera  │  │ Renderer │   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │         Havok Physics                         │   │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│  │  │  │Physics   │  │Physics   │  │Collision │   │   │   │
│  │  │  │Body      │  │World     │  │Detection │   │   │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘   │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/WebSocket
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Firebase Backend                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │   Auth  │  │ Firestore│  │  Cloud   │                  │
│  │         │  │          │  │Functions │                  │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

## Игровой цикл

```
┌─────────────────┐
│  Render Loop    │ (60 FPS)
│  (60 раз/сек)   │
└────────┬────────┘
         │
         ├──► onBeforePhysicsObservable
         │         │
         │         ├──► TankController.updatePhysics()
         │         │         │
         │         │         ├──► Применение сил
         │         │         ├──► Hover physics
         │         │         └──► Upright forces
         │         │
         ├──► Physics Step (Havok)
         │         │
         │         ├──► Обновление позиций
         │         ├──► Collision detection
         │         └──► Синхронизация с мешами
         │
         ├──► onAfterPhysicsObservable
         │         │
         │         └──► Game.updateCamera()
         │                   │
         │                   ├──► Обновление позиции камеры
         │                   ├──► Следование за танком
         │                   └──► Обработка прицеливания
         │
         └──► Scene.render()
                   │
                   ├──► Рендеринг мешей
                   ├──► Рендеринг эффектов
                   └──► Рендеринг GUI

┌─────────────────┐
│  Update Loop    │ (Оптимизированная частота)
│  (varies)       │
└────────┬────────┘
         │
         ├──► Game.update() (каждый кадр)
         │         │
         │         ├──► updateCamera() (каждые 2 кадра)
         │         ├──► ChunkSystem.update() (каждые 4 кадра)
         │         ├──► EnemyManager.update() (каждые 5 кадров)
         │         ├──► HUD.updateAnimations() (каждые 2 кадра)
         │         └──► ChatSystem.update() (каждые 4 кадра)
```

## Система физики танка

```
┌─────────────────────────────────────────────────────────┐
│              TankController                             │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Physics Body (Havok)                     │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │  │
│  │  │  Mass    │  │  COM     │  │  Shape   │      │  │
│  │  │  1000kg  │  │ (0,-0.4) │  │  Box     │      │  │
│  │  └──────────┘  └──────────┘  └──────────┘      │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Hover System                            │  │
│  │  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐       │  │
│  │  │ Ray1 │  │ Ray2 │  │ Ray3 │  │ Ray4 │       │  │
│  │  │(FL)  │  │(FR)  │  │(BL)  │  │(BR)  │       │  │
│  │  └──────┘  └──────┘  └──────┘  └──────┘       │  │
│  │     │         │         │         │            │  │
│  │     └─────────┴─────────┴─────────┘            │  │
│  │                    │                           │  │
│  │              F = -k(x-L) - cv                  │  │
│  │         (Hover Force Formula)                   │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Stabilization System                     │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │  │
│  │  │ Upright │  │ Movement │  │ Angular │      │  │
│  │  │ Force   │  │ Damping  │  │ Damping  │      │  │
│  │  └──────────┘  └──────────┘  └──────────┘      │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Movement System                          │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │  │
│  │  │ Forward │  │  Turn    │  │  Drag    │      │  │
│  │  │ Force   │  │  Torque  │  │  Forces  │      │  │
│  │  └──────────┘  └──────────┘  └──────────┘      │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## Система обновления камеры

```
┌─────────────────────────────────────────────────────────┐
│              Camera Update Flow                         │
│                                                         │
│  1. onAfterPhysicsObservable                            │
│     │                                                   │
│     ├──► Physics обновлена                             │
│     │                                                   │
│     └──► updateCamera()                                │
│           │                                             │
│           ├──► Проверка режима прицеливания            │
│           │     │                                       │
│           │     ├──► isAiming?                         │
│           │     │     │                                 │
│           │     │     ├──► YES: Aim Camera             │
│           │     │     │     │                          │
│           │     │     │     ├──► Получить позицию      │
│           │     │     │     │    ствола                │
│           │     │     │     │                          │
│           │     │     │     ├──► Вычислить направление │
│           │     │     │     │    прицеливания          │
│           │     │     │     │                          │
│           │     │     │     └──► Обновить aimCamera    │
│           │     │     │                                │
│           │     │     └──► NO: Normal Camera          │
│           │     │           │                          │
│           │     │           ├──► Получить позицию      │
│           │     │           │    танка                  │
│           │     │           │                          │
│           │     │           ├──► Вычислить угол        │
│           │     │           │    камеры                 │
│           │     │           │                          │
│           │     │           └──► Обновить camera        │
│           │     │                                       │
│           │     └──► Применить тряску камеры           │
│           │                                             │
│           └──► Синхронизация с физическим телом         │
│                 │                                       │
│                 └──► getAbsolutePosition()             │
└─────────────────────────────────────────────────────────┘
```

## Система прогресса

```
┌─────────────────────────────────────────────────────────┐
│         Player Progression System                        │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Experience System                       │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │  │
│  │  │  Kill   │  │  Damage  │  │ Capture  │     │  │
│  │  │  Exp    │  │   Exp    │  │   Exp    │     │  │
│  │  └──────────┘  └──────────┘  └──────────┘     │  │
│  │     │             │             │              │  │
│  │     └─────────────┴─────────────┘              │  │
│  │                    │                           │  │
│  │              Total Experience                   │  │
│  │                    │                           │  │
│  │              Level Up?                         │  │
│  │                    │                           │  │
│  │         ┌──────────┴──────────┐                │  │
│  │         │                     │                │  │
│  │      YES                    NO                │  │
│  │         │                     │                │  │
│  │    ┌────┴────┐          Continue              │  │
│  │    │         │                                │  │
│  │  Level++  Skill Points++                     │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Skills System                            │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐     │  │
│  │  │  Tank   │  │ Combat   │  │Survival  │     │  │
│  │  │Mastery  │  │ Expert   │  │Instinct   │     │  │
│  │  └──────────┘  └──────────┘  └──────────┘     │  │
│  │  ┌──────────┐  ┌──────────┐                   │  │
│  │  │Resource  │  │Tactical  │                   │  │
│  │  │fulness   │  │Genius    │                   │  │
│  │  └──────────┘  └──────────┘                   │  │
│  └─────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Currency System                         │  │
│  │  ┌──────────┐  ┌──────────┐                   │  │
│  │  │Credits   │  │ Premium  │                   │  │
│  │  │          │  │ Credits  │                   │  │
│  │  └──────────┘  └──────────┘                   │  │
│  └─────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## Chunk System

```
┌─────────────────────────────────────────────────────────┐
│              Chunk System                                │
│                                                         │
│  Player Position: (x, z)                                │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  Calculate Current Chunk                    │       │
│  │  chunkX = floor(x / chunkSize)              │       │
│  │  chunkZ = floor(z / chunkSize)              │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  Determine Load/Unload Range                │       │
│  │  Load:  renderDistance chunks               │       │
│  │  Unload: unloadDistance chunks              │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ├──► Load New Chunks                           │
│         │     │                                         │
│         │     ├──► Generate Terrain                     │
│         │     ├──► Place Garages                        │
│         │     ├──► Add Consumables                     │
│         │     └──► Create Meshes                       │
│         │                                               │
│         └──► Unload Old Chunks                         │
│               │                                         │
│               ├──► Dispose Meshes                      │
│               ├──► Clear Physics Bodies                │
│               └──► Free Memory                         │
│                                                         │
│  ┌─────────────────────────────────────────────┐       │
│  │  Chunk Map (Map<"x,z", Chunk>)             │       │
│  │  ┌──────┐  ┌──────┐  ┌──────┐            │       │
│  │  │-1,-1 │  │ 0,-1 │  │ 1,-1 │            │       │
│  │  └──────┘  └──────┘  └──────┘            │       │
│  │  ┌──────┐  ┌──────┐  ┌──────┐            │       │
│  │  │-1, 0 │  │ 0, 0 │  │ 1, 0 │  ← Player │       │
│  │  └──────┘  └──────┘  └──────┘            │       │
│  │  ┌──────┐  ┌──────┐  ┌──────┐            │       │
│  │  │-1, 1 │  │ 0, 1 │  │ 1, 1 │            │       │
│  │  └──────┘  └──────┘  └──────┘            │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

## Синхронизация физики и рендеринга

```
┌─────────────────────────────────────────────────────────┐
│         Physics-Render Synchronization                  │
│                                                         │
│  Frame N                                                │
│  ┌─────────────────────────────────────────────┐       │
│  │  onBeforePhysicsObservable                   │       │
│  │  │                                           │       │
│  │  ├──► Read mesh.position                    │       │
│  │  │    (синхронизировано с предыдущим        │       │
│  │  │     шагом физики)                        │       │
│  │  │                                           │       │
│  │  └──► Apply forces to PhysicsBody           │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  Physics Step (Havok)                       │       │
│  │  │                                           │       │
│  │  ├──► Calculate new positions               │       │
│  │  ├──► Resolve collisions                    │       │
│  │  └──► Update PhysicsBody transforms        │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  Havok syncs mesh.position                  │       │
│  │  (автоматически)                            │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  onAfterPhysicsObservable                   │       │
│  │  │                                           │       │
│  │  ├──► Read mesh.getAbsolutePosition()       │       │
│  │  │    (актуальная позиция после физики)     │       │
│  │  │                                           │       │
│  │  └──► Update camera                         │       │
│  └─────────────────────────────────────────────┘       │
│         │                                               │
│         ▼                                               │
│  ┌─────────────────────────────────────────────┐       │
│  │  Scene.render()                             │       │
│  │  │                                           │       │
│  │  └──► Render meshes at current positions    │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
│  Frame N+1 (повторяется)                              │
└─────────────────────────────────────────────────────────┘
```

## Взаимодействие систем

```
┌─────────────┐
│   Input     │
│  (Keyboard/ │
│   Mouse)    │
└──────┬──────┘
       │
       ▼
┌─────────────┐      ┌─────────────┐
│    Game     │◄────►│   Tank     │
│             │      │ Controller │
└──────┬──────┘      └──────┬──────┘
       │                    │
       │                    ▼
       │            ┌─────────────┐
       │            │  Physics    │
       │            │   Body      │
       │            └──────┬──────┘
       │                  │
       │                  ▼
       │            ┌─────────────┐
       │            │   Mesh     │
       │            │  Position  │
       │            └──────┬──────┘
       │                  │
       ▼                  ▼
┌─────────────┐      ┌─────────────┐
│   Camera    │◄────►│    HUD      │
│             │      │             │
└──────┬──────┘      └──────┬──────┘
       │                    │
       │                    ▼
       │            ┌─────────────┐
       │            │  Renderer   │
       │            │  (Babylon)  │
       │            └─────────────┘
       │
       ▼
┌─────────────┐
│   Screen    │
└─────────────┘
```

Эти диаграммы помогают визуализировать архитектуру и взаимодействие систем в Protocol TX.

