# Protocol TX System Monitor

Терминальный дашборд мониторинга всех систем проекта в хакерском стиле.

## Быстрый старт

```bash
# Запуск мониторинга
npm run monitor

# Запуск с кастомной конфигурацией
npm run monitor -- --config ./custom-config.json
```

## Горячие клавиши

### Функциональные клавиши

- **F1** - Помощь (список всех команд и модальное окно)
- **F2** - Конфигурация (настройки мониторинга, модальное окно)
- **F3** - Экспорт данных (JSON/CSV/HTML/TXT)
- **F4** - Просмотр алертов (история и настройка, модальное окно)
- **F5** - Детальный просмотр игроков (модальное окно)
- **F6** - Детальный просмотр комнат (модальное окно)

### Навигация

- **TAB** - Переключение фокуса между секциями
- **↑/↓** - Прокрутка логов
- **←/→** - Прокрутка истории графиков

### Управление логами

- **F** - Циклическое переключение фильтра логов (ALL → INFO → WARN → ERROR)
- **S** - Поиск в логах (открывает модальное окно ввода)
- **E** - Экспорт логов в файл
- **C** - Очистка логов

### Управление графиками

- **Z** - Переключение зума графика (1x → 2x → 4x → 1x)
- **←** - Прокрутка истории графиков назад (на 10 образцов)
- **→** - Прокрутка истории графиков вперед (на 10 образцов)

### Общие

- **R** - Обновление метрик вручную
- **ESC** - Закрыть модальное окно / Выход
- **Q** - Выход

## Секции интерфейса

### System Status
Отображает статус всех систем:
- Vite Dev Server (порт 3000)
- WebSocket Server (порт 8000)
- Firebase
- Physics Engine
- Network

### Performance
Метрики производительности:
- CPU использование (%) и количество ядер
- RAM использование (MB/GB) и процент использования
- Server FPS (tick rate) и детальная статистика (avg/min/max tick time)
- Client FPS (если доступен, агрегированный по всем подключенным клиентам)
- Latency (задержка)
- Расширенные клиентские метрики (если доступны):
  - GPU информация (renderer, vendor, memory)
  - Physics (objects, bodies, simulation time)
  - Scene (meshes, lights, textures)
  - Effects (particles, systems)
  - Audio (sources, playing)

### Connections
Информация о подключениях:
- Игроки онлайн
- Активные комнаты
- Игроки в очереди
- WebSocket соединения
- Средний ping

### Alerts
Система алертов с визуальными индикаторами:
- CPU > 90% (настраиваемый порог)
- RAM > 95% (настраиваемый порог)
- Server FPS < 55 (настраиваемый порог)
- Client FPS < 55 (если доступен)
- Latency > 100ms (настраиваемый порог)
- Серверы офлайн (Vite, WebSocket, Firebase)
- Высокая загрузка комнат
- Высокий сетевой трафик
- История алертов с отметками времени разрешения
- Визуальные эффекты (мигание для критических алертов)

### Resources
Графики использования ресурсов:
- CPU (прогресс-бар)
- RAM (прогресс-бар)
- Network (входящий/исходящий трафик)

### Game State
Текущее состояние игры:
- Список активных комнат
- Количество игроков в каждой комнате
- Статус комнат (WAITING, ACTIVE, IN_PROGRESS)
- Время игры

### Metrics History
История метрик с графиками:
- CPU (sparkline)
- RAM (sparkline)
- Server FPS (sparkline)
- Client FPS (sparkline, если доступен)
- Последние 60 образцов (настраивается зумом)
- Управление зумом (клавиша Z)
- Прокрутка по времени (стрелки ←→)

### Logs
Расширенная система логов:
- Цветовое кодирование по уровню (INFO - зеленый, WARN - желтый, ERROR - красный)
- Фильтрация по уровню (клавиша F, цикл: ALL → INFO → WARN → ERROR)
- Поиск по ключевым словам (клавиша S)
- Буфер: последние 200 строк (увеличено с 100)
- Экспорт логов (клавиша E)
- Очистка логов (клавиша C)
- Автоматическая прокрутка к последним записям

## Конфигурация

Файл конфигурации: `scripts/monitor/config.json`

```json
{
  "server": {
    "host": "localhost",
    "port": 8000,
    "reconnectInterval": 5000
  },
  "client": {
    "viteUrl": "http://localhost:3000",
    "checkInterval": 1000
  },
  "updateInterval": 16,
  "history": {
    "enabled": true,
    "duration": 1800,
    "interval": 1000
  },
  "alerts": {
    "enabled": true,
    "sound": false,
    "rules": {
      "cpuThreshold": 90,
      "ramThreshold": 95,
      "fpsThreshold": 55,
      "latencyThreshold": 100
    }
  },
  "ui": {
    "theme": "terminal-green",
    "refreshRate": 60
  },
  "export": {
    "defaultFormat": "json",
    "defaultPath": "./monitor-exports"
  }
}
```

## Темы оформления

Доступные темы:
- `terminal-green` - Классический зеленый терминал с ASCII-арт (по умолчанию)
- `amber` - Янтарный терминал
- `matrix` - Matrix стиль с зеленым эффектом
- `cyberpunk` - Киберпанк стиль с неоновыми цветами
- `retro` - Ретро монохромный

Все темы включают:
- ASCII-арт заголовок
- Анимированные индикаторы статуса (мигание)
- Цветовое кодирование по типам сообщений
- Визуальные эффекты для алертов

## Экспорт данных

Поддерживаемые форматы:
- **JSON** - Все метрики, история, алерты
- **CSV** - Метрики по времени
- **HTML** - Красивый отчет с графиками
- **TXT** - Простой текстовый формат

Экспорт выполняется нажатием **F3** или программно через API.

## Примеры использования

### Просмотр детальной статистики игроков

1. Нажмите **F5** для открытия модального окна с информацией о всех игроках
2. Используйте стрелки для прокрутки списка
3. Нажмите **ESC** для закрытия

### Анализ истории производительности

1. Используйте **Z** для увеличения зума графика (просмотр более детальной истории)
2. Используйте **←/→** для прокрутки по временной оси
3. Графики показывают CPU, RAM, Server FPS и Client FPS

### Фильтрация логов

1. Нажмите **F** для переключения фильтра (ALL → INFO → WARN → ERROR)
2. Нажмите **S** для поиска по ключевым словам
3. Используйте **↑/↓** для прокрутки отфильтрованных логов
4. Нажмите **C** для очистки логов

### Экспорт данных

1. Нажмите **F3** для экспорта текущих метрик
2. Данные экспортируются в формате, указанном в конфигурации
3. Файл сохраняется в директории `export.defaultPath`

## Troubleshooting

### Мониторинг не подключается к серверу

1. Убедитесь, что сервер запущен: `npm run server`
2. Проверьте порт в конфигурации (по умолчанию 8000)
3. Проверьте, что WebSocket сервер доступен
4. Проверьте логи на наличие ошибок подключения

### Vite не определяется как онлайн

1. Убедитесь, что Vite dev server запущен: `npm run dev`
2. Проверьте URL в конфигурации (по умолчанию http://localhost:3000)
3. Проверьте, что порт 3000 не занят другим процессом
4. Проверьте сетевые настройки и файрвол

### Клиентские метрики не отображаются

1. Убедитесь, что игроки подключены к серверу
2. Клиентские метрики собираются сервером через WebSocket от игроков
3. Метрики агрегируются и отображаются в секции Performance
4. Если метрики отсутствуют, возможно клиенты еще не отправили данные

### Высокое использование CPU

Мониторинг обновляется 60 раз в секунду. Если это слишком много:
- Увеличьте `updateInterval` в конфигурации (например, до 100ms для ~10 FPS)
- Отключите историю: `"history": { "enabled": false }`
- Уменьшите размер истории: `"history": { "duration": 600 }` (10 минут вместо 30)

### Модальные окна не закрываются

1. Нажмите **ESC** для закрытия активного модального окна
2. Если окно зависло, попробуйте нажать **Q** для выхода из мониторинга
3. Проверьте, что терминал поддерживает функциональные клавиши

### Ошибки при экспорте

1. Убедитесь, что директория экспорта существует и доступна для записи
2. Проверьте права доступа к файловой системе
3. Убедитесь, что достаточно места на диске
4. Проверьте формат экспорта в конфигурации (json, csv, html, txt)

## Архитектура

Мониторинг состоит из следующих модулей:

- **Core** (`scripts/monitor/core.ts`) - Ядро системы, координация всех компонентов
- **Metrics Manager** (`scripts/monitor/metrics.ts`) - Управление сбором метрик, агрегация данных
- **Collectors** (`scripts/monitor/collectors/`) - Коллекторы метрик:
  - `serverCollector.ts` - Метрики сервера через WebSocket
  - `clientCollector.ts` - Статус Vite dev server (клиентские метрики собираются сервером)
  - `systemCollector.ts` - Системные метрики (CPU, RAM, Disk)
  - `networkCollector.ts` - Сетевые метрики
  - `firebaseCollector.ts` - Статус Firebase
- **History Manager** (`scripts/monitor/history.ts`) - Хранение истории метрик (кольцевой буфер)
- **Alert Manager** (`scripts/monitor/alerts.ts`) - Система алертов с правилами и уведомлениями
- **UI Manager** (`scripts/monitor/ui.ts`) - Расширенный терминальный интерфейс с модальными окнами
- **Export Manager** (`scripts/monitor/export.ts`) - Экспорт данных в различные форматы
- **Config Manager** (`scripts/monitor/config.ts`) - Управление конфигурацией

### Особенности UI

- **Модальные окна** - Полноэкранные диалоги для детального просмотра (Help, Config, Alerts, Players, Rooms)
- **Графики с зумом** - Интерактивные графики истории метрик с управлением масштабом
- **Расширенные логи** - Фильтрация, поиск, цветовое кодирование, буфер 200 строк
- **Анимации** - Мигающие индикаторы статуса, визуальные эффекты для алертов
- **ASCII-арт** - Стилизованные заголовки в хакерском стиле

## API

### Server Monitoring API

Сервер экспортирует статистику через WebSocket:

```typescript
// Подключение к мониторингу
ws.send(JSON.stringify({
    type: 'monitoring_connect',
    data: {},
    timestamp: Date.now()
}));

// Получение статистики
// Сервер отправляет сообщения типа 'monitoring_stats' каждую секунду
```

### Методы GameServer

```typescript
server.getStats() // Базовая статистика
server.getDetailedRoomStats() // Детальная статистика комнат
server.getDetailedPlayerStats() // Детальная статистика игроков
server.getMonitoringAPI() // Полный доступ к Monitoring API
```

## Разработка

### Добавление новой метрики

1. Добавьте метрику в соответствующий коллектор (`scripts/monitor/collectors/`)
2. Обновите интерфейс `MetricsSnapshot` в `scripts/monitor/metrics.ts`
3. Добавьте сбор метрики в `MetricsManager.collectMetrics()`
4. Добавьте отображение в `UIManager` (соответствующая секция)
5. При необходимости добавьте метрику в графики истории

### Добавление нового алерта

1. Добавьте правило в `AlertManager.checkMetrics()` (`scripts/monitor/alerts.ts`)
2. Настройте порог в конфигурации (`scripts/monitor/config.json`)
3. Добавьте обработку в UI (обновление панели алертов в `UIManager`)
4. При необходимости добавьте визуальные эффекты для критических алертов

### Добавление новой темы

1. Добавьте тему в `themes` объект в `scripts/monitor/ui.ts`
2. Настройте цвета (fg, bg, border, success, warning, error, info)
3. При необходимости добавьте специальные эффекты (анимации, ASCII-арт)
4. Обновите документацию

### Добавление нового модального окна

1. Добавьте метод `showYourModal()` в `UIManager`
2. Используйте `showModal()` для создания модального окна
3. Добавьте горячую клавишу в `setupKeyboard()`
4. Добавьте обработку закрытия по ESC (автоматически через `showModal()`)

### Расширение функционала логов

1. Логи хранятся в `logLines` массиве в `UIManager`
2. Используйте `addLog()` для добавления новых записей
3. Фильтрация через `filterLogs()`, поиск через `searchLogs()`
4. Обновите `updateLogsDisplay()` для новых функций отображения

## Лицензия

ISC

