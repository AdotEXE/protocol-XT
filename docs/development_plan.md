# Техническая спецификация: Protocol TX (WebGPU / Babylon.js / Havok)

## 1. Введение и Технологический Контекст
Разработка высокопроизводительного трехмерного шутера в среде веб-браузера представляет собой одну из сложнейших задач современной программной инженерии. Цель проекта — воссоздание механик **Tanki X** в стилистике **Low Poly** с использованием передовых веб-технологий.

Анализ текущего состояния веб-стандартов показывает, что мы находимся в точке технологического перелома. Появление стандарта **WebGPU**, релиз физического движка **Havok** в формате WebAssembly и интеграция облачных сред разработки (**Project IDX**) позволяют создавать продукты, ранее доступные только в виде нативных приложений.

## 2. Среда разработки: Project IDX и Экосистема Firebase

### 2.1 Конфигурация среды через Nix
Проект нацелен на использование в Project IDX. Файл `dev.nix` конфигурирует окружение:
*   **Node.js 20 (LTS):** Среда выполнения сборщика (Vite) и локального сервера.
*   **OpenJDK 11+:** Запуск эмуляторов Firebase.
*   **Basis Universal CLI & Draco Encoder:** Утилиты для автоматического сжатия ассетов (CI/CD пайплайн).

### 2.2 Интеграция с Firebase (BaaS)
*   **Firestore:** Хранение мета-данных игрока (гараж, улучшения, валюта).
*   **Firebase Authentication:** Анонимный вход и SSO (Google).
*   **Cloud Functions:** Транзакции и матчмейкинг.

## 3. Графический движок: Babylon.js + WebGPU
Выбор **Babylon.js** обоснован его архитектурой как игрового фреймворка, а не просто графической библиотеки.
*   **WebGPUEngine:** Абстракция позволяет использовать один код для WebGL2 и WebGPU.
*   **Compute Shaders:** Реализация сложных эффектов частиц (дым, взрывы) на GPU.
*   **Snapshot Rendering:** Автоматическая оптимизация Draw Calls для статических сцен.

### 3.1 Эстетика "Optimized Low Poly"
*   **Flat Shading:** Процедурное вычисление нормалей в шейдере (`dFdx`, `dFdy`) вместо дублирования вершин.
*   **Vertex Colors / Baked AO:** Запекание Ambient Occlusion в вершины для объема без затрат на рантайм-освещение.

## 4. Физическая симуляция: Havok Physics
Использование плагина **HavokPlugin** в Babylon.js обеспечивает доступ к индустриальному стандарту физики.
*   **Детерминизм:** Высокий (критично для сетевой синхронизации).
*   **Vehicle Physics:** Использование Raycast Vehicle модели для симуляции гусениц (стабильнее, чем самописные решения на Rapier).
    *   4 луча (по углам корпуса).
    *   Формула подвески: $F = -k \cdot (x - L_{rest}) - c \cdot v$.
    *   Анизотропное трение для реализации дрифта.

## 5. Стратегия доставки контента (Asset Delivery)
*   **Геометрия:** Формат **glTF** + сжатие **Draco** (квантование вершин).
*   **Текстуры:** Формат **KTX2** + суперсжатие **Basis Universal** (декодирование GPU "на лету").

## 6. Сетевая архитектура
*   **Гибридная модель:**
    *   **WebSockets:** Надежная доставка (чат, лобби, покупки).
    *   **WebTransport (или UDP-like via Geckos.io):** Ненадежная доставка стейта (позиции танков).
*   **Lag Compensation:**
    *   **Client-Side Prediction:** Мгновенный отклик на ввод.
    *   **Entity Interpolation:** Плавное движение врагов.
    *   **Server Reconciliation:** Коррекция рассинхрона.

## 7. План разработки (Roadmap)

### Фаза 1: Фундамент (Недели 1-4)
1.  Инициализация проекта (Vite + Babylon.js + Havok).
2.  Настройка `dev.nix` для Project IDX.
3.  Реализация базового контроллера танка (Havok Raycast Vehicle).
4.  Настройка загрузчиков `.glb` (Draco) и `.ktx2`.

### Фаза 2: Сетевое ядро (Недели 5-10)
1.  Разработка авторитетного сервера (Node.js).
2.  Реализация бинарной сериализации (FlatBuffers/BitBuffer).
3.  Интеграция интерполяции и предсказания.

### Фаза 3: Геймплей и Арт (Недели 11-16) ✅ В ПРОЦЕССЕ
1.  ✅ Система вооружения (Hitscan, Projectiles) - Реализовано
2.  ✅ UI (HTML/GUI поверх Canvas) - Реализовано
3.  ✅ Интеграция Firebase (Auth, Firestore) - Реализовано
4.  ✅ WebGPU шейдеры и эффекты - Реализовано
5.  ✅ Система прицеливания с зумом - Реализовано
6.  ✅ Система прогресса и опыта - Реализовано
7.  ✅ Chunk System для генерации мира - Реализовано
8.  ✅ AI враги - Реализовано

### Критические исправления (2025-12-XX)
- ✅ **Синхронизация физики и рендеринга**: Исправлена проблема тряски танка при движении
  - Камера обновляется после шага физики в `onAfterPhysicsObservable`
  - Использование `getAbsolutePosition()` для правильной синхронизации позиции
  - Улучшена синхронизация между PhysicsBody и визуальным мешем
  
- ✅ **Инициализация камеры**: Исправлен черный экран при запуске игры
  - Подписка на события физики перенесена в правильное место
  - Добавлена проверка активной камеры перед рендерингом
  - Создание временной камеры по умолчанию при необходимости
