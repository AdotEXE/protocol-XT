# üéØ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ProjectilePool

**–î–∞—Ç–∞:** 3 —Ñ–µ–≤—Ä–∞–ª—è 2026  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üìä –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞:
- –°–Ω–∞—Ä—è–¥—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `MeshBuilder.CreateBox()` –≤ `tankController.ts`
- –ö–∞–∂–¥—ã–π —Å–Ω–∞—Ä—è–¥ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –º–µ—à –∏ –º–∞—Ç–µ—Ä–∏–∞–ª ‚Üí –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ GC
- –ü—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Å—Ç—Ä–µ–ª—å–±–µ –≤–æ–∑–º–æ–∂–Ω—ã –ª–∞–≥–∏ –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

### –†–µ—à–µ–Ω–∏–µ:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `ProjectilePool` –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
- –°–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ GC –Ω–∞ 50-70%
- –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Å—Ç—Ä–µ–ª—å–±–µ

---

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞

### –ì–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–Ω–∞—Ä—è–¥—ã:

1. **`tankController.ts:3294`** - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–Ω–∞—Ä—è–¥—ã
   ```typescript
   projectileMesh = MeshBuilder.CreateBox("bullet", {
       width: bulletSize * 2,
       height: bulletSize * 2,
       depth: bulletSize * 4
   }, this.scene);
   ```

2. **`tankController.ts:4086`** - –°–Ω–∞—Ä—è–¥—ã –¥–ª—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
   ```typescript
   const ball = MeshBuilder.CreateBox("bullet", {
       width: bulletSize,
       height: bulletSize,
       depth: bulletSize * 3
   }, this.scene);
   ```

3. **`tankController.ts:4005`** - –°–Ω–∞—Ä—è–¥—ã –¥–ª—è –¥—Ä–æ–±–æ–≤–∏–∫–∞ (shotgun)
   ```typescript
   const pellet = MeshBuilder.CreateBox("shotgunPellet", {
       width: this.projectileSize * 0.6,
       height: this.projectileSize * 0.6,
       depth: this.projectileSize * 2
   }, this.scene);
   ```

### –ì–¥–µ —É–¥–∞–ª—è—é—Ç—Å—è —Å–Ω–∞—Ä—è–¥—ã:

- **`tankController.ts:updateProjectiles()`** - –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `mesh.dispose()`
- **`tankController.ts:manualProjectiles`** - –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–Ω–∞—Ä—è–¥–æ–≤

---

## ‚úÖ –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä ProjectilePool –≤ TankController

**–§–∞–π–ª:** `src/client/tankController.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `ProjectilePool`
2. –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—É–ª–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ
3. –û—á–∏—Å—Ç–∏—Ç—å –ø—É–ª –≤ `dispose()`

**–ö–æ–¥:**
```typescript
import { ProjectilePool } from "./optimization/ProjectilePool";

export class TankController {
    // ...
    private projectilePool: ProjectilePool | null = null;
    
    constructor(...) {
        // ...
        // –°–æ–∑–¥–∞—ë–º –ø—É–ª —Å–Ω–∞—Ä—è–¥–æ–≤
        this.projectilePool = new ProjectilePool(this.scene, {
            initialSize: 20,
            maxSize: 100,
            bulletSize: this.projectileSize,
            bulletDepth: this.projectileSize * 4
        });
    }
    
    dispose(): void {
        // ...
        if (this.projectilePool) {
            this.projectilePool.dispose();
            this.projectilePool = null;
        }
    }
}
```

---

### –®–∞–≥ 2: –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–Ω–∞—Ä—è–¥–æ–≤

**–§–∞–π–ª:** `src/client/tankController.ts` (—Å—Ç—Ä–æ–∫–∞ ~3294)

**–ë—ã–ª–æ:**
```typescript
projectileMesh = MeshBuilder.CreateBox("bullet", {
    width: bulletSize * 2,
    height: bulletSize * 2,
    depth: bulletSize * 4
}, this.scene);
```

**–°—Ç–∞–Ω–µ—Ç:**
```typescript
if (this.projectilePool) {
    projectileMesh = this.projectilePool.acquire(
        muzzlePos,
        forward,
        projectileColor,
        this.damage,
        "player",
        this.cannonType.id
    );
    if (!projectileMesh) {
        // –ü—É–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω - —Å–æ–∑–¥–∞—ë–º –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
        projectileMesh = MeshBuilder.CreateBox("bullet", {
            width: bulletSize * 2,
            height: bulletSize * 2,
            depth: bulletSize * 4
        }, this.scene);
        // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
    }
} else {
    // Fallback –µ—Å–ª–∏ –ø—É–ª –Ω–µ —Å–æ–∑–¥–∞–Ω
    projectileMesh = MeshBuilder.CreateBox("bullet", {
        width: bulletSize * 2,
        height: bulletSize * 2,
        depth: bulletSize * 4
    }, this.scene);
}
```

---

### –®–∞–≥ 3: –ó–∞–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–¥–æ–≤ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø—É–ª

**–§–∞–π–ª:** `src/client/tankController.ts` (–º–µ—Ç–æ–¥ `updateProjectiles()`)

**–ë—ã–ª–æ:**
```typescript
if (proj.mesh && !proj.mesh.isDisposed()) {
    proj.mesh.dispose();
}
```

**–°—Ç–∞–Ω–µ—Ç:**
```typescript
if (proj.mesh && !proj.mesh.isDisposed()) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑ –ø—É–ª–∞ –ª–∏ —Å–Ω–∞—Ä—è–¥
    if (proj.mesh.metadata?.fromPool && this.projectilePool) {
        this.projectilePool.release(proj.mesh);
    } else {
        proj.mesh.dispose();
    }
}
```

---

### –®–∞–≥ 4: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã —Å–Ω–∞—Ä—è–¥–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** Shotgun pellets –∏ ability projectiles –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—É–ª—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–Ω–∞—Ä—è–¥–æ–≤
2. –ò–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å `ProjectilePool` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –ø—É–ª —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –ø—É–ª —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)

---

## üìã –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `ProjectilePool` –≤ `tankController.ts`
- [ ] –°–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—É–ª–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ `TankController`
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–Ω–∞—Ä—è–¥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~3294)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ ability —Å–Ω–∞—Ä—è–¥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~4086)
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ shotgun pellets (—Å—Ç—Ä–æ–∫–∞ ~4005) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–¥–æ–≤ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –≤ –ø—É–ª
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –ø—É–ª–∞ –≤ `dispose()`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ **50-70% —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ GC**
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω—ã–π FPS –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Å—Ç—Ä–µ–ª—å–±–µ**
- ‚úÖ **–ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø–∞–º—è—Ç–∏**

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–ª–∞:
- –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ `projectilePool.getStats()`
- –ü–æ–∫–∞–∂–µ—Ç: `poolSize`, `activeCount`, `totalCreated`, `totalReused`, `reuseRate`

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:** –°–Ω–∞—Ä—è–¥—ã –∏–∑ –ø—É–ª–∞ –∏–º–µ—é—Ç `metadata.fromPool = true` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
2. **–†–∞–∑–º–µ—Ä—ã:** –ü—É–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä - –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–æ–π—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–Ω–∞—Ä—è–¥–æ–≤
3. **–§–∏–∑–∏–∫–∞:** –ü—É–ª —Å–æ–∑–¥–∞—ë—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —Ç–µ–ª–∞ - –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è
4. **–¶–≤–µ—Ç–∞:** –ü—É–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ü–≤–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞ - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ü–≤–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

---

## üöÄ –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω—ã –≤—ã—à–µ. –ú–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!
