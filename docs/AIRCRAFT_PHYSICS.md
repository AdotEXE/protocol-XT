# Авиационная физика с Mouse-Aim системой

## Обзор

Реализована продвинутая система управления самолётом с Mouse-Aim (Fly-by-Wire) контролем, реалистичной аэродинамикой и PID регулятором для плавного управления.

## Архитектура

### Основные компоненты

1. **AircraftPhysics** (`src/client/tank/aircraftPhysics.ts`)
   - Главный класс управления физикой самолёта
   - Интегрирует все подсистемы
   - Использует Havok Physics (DYNAMIC режим)

2. **MouseAimSystem** (`src/client/tank/mouseAimSystem.ts`)
   - Unprojection мыши в 3D пространство
   - Вычисление целевого вектора
   - Instructor layer (координированные повороты)
   - Ограничение угла атаки

3. **PIDController** (`src/client/tank/pidController.ts`)
   - Пропорционально-интегрально-дифференциальный регулятор
   - Плавное управление по pitch, yaw, roll
   - Предотвращение осцилляций

4. **AerodynamicsSystem** (`src/client/tank/aerodynamicsSystem.ts`)
   - Реалистичные аэродинамические силы
   - Lift (подъёмная сила) с учётом угла атаки
   - Drag (сопротивление) паразитное и индуцированное
   - Thrust (тяга) двигателя
   - Обнаружение сваливания

5. **AircraftHUD** (`src/client/hud/components/AircraftHUD.ts`)
   - Aim Circle (цель мыши)
   - Heading Cross (направление самолёта)
   - Stall warning indicator
   - G-force indicator

6. **AircraftCameraSystem** (`src/client/tank/aircraftCameraSystem.ts`)
   - Продвинутая chase camera
   - Spring arm dynamics
   - FOV изменения при ускорении

## Конфигурация

Все параметры настраиваются в `src/client/config/aircraftPhysicsConfig.ts`:

- **PID параметры**: Kp, Ki, Kd для каждой оси
- **Аэродинамика**: плотность воздуха, площадь крыла, коэффициенты
- **Mouse-Aim**: look-ahead, крен, угол атаки; **mouseAimGain**, **mouseAimDeadzone**, **pointerLockSensitivityMultiplier**; **mouseAimSmoothing**, **maxSmoothedDeltaPerFrame**, **maxRotationSpeedRadPerSec**; **mouseAimFollowGain** (целевая угловая скорость = ошибка × gain — у центра естественное замедление); **mouseAimBlendToTarget** (скорость перехода текущей угловой скорости к целевой за кадр)
- **Клавиатура**: чувствительность для прямого управления
- **Камера**: расстояние, высота, плавность следования
- **Самовыравнивание**: **enableAutoLevel**, **autoLevelStrength** (крен + тангаж в уровень при отпускании ручки)
- **Level assist**: **levelAssistStrength** (0–1) — слабая постоянная подтяжка в уровень при активном вводе (самолёт стремится в уровень даже при следовании за курсором)
- **Разворот к камере**: **cameraAlignGain** (нос к центру экрана при отсутствии ввода)
- **STALL**: **stallWarningMinSpeed** (м/с) — ниже этой скорости предупреждение «STALL!» не показывается

## Управление

### Mouse-Aim (основной режим)
- **Мышь**: определяет целевую точку в 3D пространстве (центр прицела)
- **Следование за центром**: при управлении только мышью целевая угловая скорость задаётся пропорционально угловой ошибке (нос ↔ центр камеры). У центра ошибка мала → скорость вращения падает → самолёт плавно останавливается на прицеле, без проскакивания и «ускорения» к центру
- **Instructor**: автоматически управляет креном и pitch для достижения цели
- **Координированные повороты**: автоматический крен при горизонтальных поворотах

### Клавиатура (переопределение)
- **W/S**: Pitch (нос вверх/вниз)
- **A/D**: Roll (крен влево/вправо)
- **Q/E**: Yaw (рыскание)
- **Shift**: Увеличить тягу
- **Ctrl**: Уменьшить тягу

## Физика

### Аэродинамические силы

**Lift (Подъёмная сила)**:
```
L = 0.5 * ρ * v² * A * Cl(α)
```
- Зависит от угла атаки (α)
- Линейная зависимость до критического угла
- Экспоненциальное падение при сваливании

**Drag (Сопротивление)**:
```
D = D_parasitic + D_induced
D_induced = 0.5 * ρ * v² * A * k * Cl²
```
- Паразитное сопротивление (постоянное)
- Индуцированное сопротивление (зависит от подъёмной силы)

**Thrust (Тяга)**:
```
T = T_min + (T_max - T_min) * throttle
```
- Зависит от процента газа (0-1)
- Применяется вдоль направления "вперёд" самолёта

### PID регулятор

Для каждой оси (pitch, yaw, roll):
```
output = Kp * error + Ki * integral + Kd * derivative
```

- **Proportional (Kp)**: быстрая реакция на ошибку
- **Integral (Ki)**: устранение постоянной ошибки
- **Derivative (Kd)**: предотвращение осцилляций

## HUD элементы

### Aim Circle (Зелёный круг)
- Показывает цель мыши (куда хотим лететь)
- Обновляется в реальном времени
- Позиция вычисляется через unprojection мыши

### Heading Cross (Жёлтый крест)
- Показывает текущее направление самолёта
- Позволяет видеть "ошибку" между целью и направлением

### Stall Warning
- Появляется при превышении критического угла атаки и скорости выше `stallWarningMinSpeed` (по умолчанию 8 м/с)
- Пульсирует красным цветом

### G-force Indicator
- Показывает текущую перегрузку
- Меняет цвет при высокой перегрузке (красный > 7G)

## Оптимизации

1. **Кэширование**: позиции и направления кэшируются на кадр
2. **Ограничение dt**: предотвращение больших скачков при низком FPS
3. **Упрощённые коллайдеры**: для самолёта используется простой convex hull
4. **Адаптивные интервалы**: обновление HUD не каждый кадр

## Интеграция

Система автоматически активируется при выборе самолёта (chassisType.id === "plane"):

1. `TankMovementModule` создаёт `AircraftPhysics` при обнаружении самолёта
2. `Game.ts` обновляет позицию мыши для Mouse-Aim
3. `HUD` отображает ретикли и индикаторы
4. `GameCamera` использует улучшенную chase camera

## Настройка

Все параметры можно изменить в `DEFAULT_AIRCRAFT_PHYSICS_CONFIG`:

```typescript
// Пример: увеличить чувствительность PID
pid: {
    pitchKp: 10.0,  // Было 8.0
    pitchKd: 15.0,  // Было 12.0
    // ...
}

// Пример: изменить расстояние look-ahead
mouseAim: {
    lookAheadDistance: 1500.0,  // Было 1000.0
    // ...
}
```

## Производительность

- **Целевой FPS**: 60 FPS
- **Physics frequency**: 60 Hz (синхронизировано с рендерингом)
- **HUD updates**: каждые 3-6 кадров (адаптивно)
- **Кэширование**: все дорогие вычисления кэшируются на кадр

## Известные ограничения

1. G-force вычисление упрощённое (не использует реальное ускорение)
2. Аэродинамика упрощённая (нет учёта турбулентности, вихрей)
3. Звуковые эффекты не реализованы (TODO)

## Будущие улучшения

- [ ] Реалистичное вычисление G-force через отслеживание ускорения
- [ ] Звуковые эффекты (двигатель, ветер, предупреждения)
- [ ] Визуальные эффекты (blackout/redout при высокой перегрузке)
- [ ] Улучшенная модель сваливания (flat spin, recovery)
- [ ] Landing gear система
- [ ] Ground effect при посадке



