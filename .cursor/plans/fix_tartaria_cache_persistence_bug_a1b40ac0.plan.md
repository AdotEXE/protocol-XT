# План исправления проблемы с картой Тартарии

## Проблема
Все карты загружаются как Тартария (холмы, река Эмайыги, город), даже если выбрана другая карта и Тартарию никогда не загружали в этой сессии.

## Корневая причина
Функция `getTartuHeight()` в `tartuHeightmap.ts` автоматически инициализирует глобальный кэш `tartuHeightmapCache`, если он не инициализирован (строка 182-184). Это означает, что даже если проверка `mapType === "tartaria"` работает правильно, кэш может быть инициализирован случайно или использован где-то без проверки.

## Решение

### 1. Убрать автоматическую инициализацию из `getTartuHeight()`
В файле `[src/client/tartuHeightmap.ts](src/client/tartuHeightmap.ts)`:
- Удалить автоматическую инициализацию в функции `getTartuHeight()` (строки 182-184)
- Вместо этого выбрасывать ошибку или возвращать 0, если кэш не инициализирован
- Это гарантирует, что кэш инициализируется ТОЛЬКО когда явно вызывается `initTartuHeightmap()` для карты Тартарии

### 2. Добавить защитные проверки в `getTartuHeight()`
- Добавить проверку, что кэш инициализирован перед использованием
- Выбрасывать понятную ошибку, если кэш используется без инициализации

### 3. Убедиться, что `initTartuHeightmap()` вызывается только для Тартарии
В файле `[src/client/noiseGenerator.ts](src/client/noiseGenerator.ts)`:
- Проверить, что `initTartuHeightmap()` вызывается только в конструкторе `TerrainGenerator`, когда `mapType === "tartaria"`
- Убедиться, что динамический импорт работает правильно

### 4. Добавить проверку в `getTartuBiome()`
В файле `[src/client/tartuBiomes.ts](src/client/tartuBiomes.ts)`:
- Убедиться, что `getTartuBiome()` вызывается только для Тартарии (уже есть проверка в `chunkSystem.ts:195`)

### 5. Добавить логирование для отладки
- Добавить логи, когда `getTartuHeight()` вызывается без инициализированного кэша
- Это поможет найти места, где кэш используется неправильно

## Файлы для изменения
1. `src/client/tartuHeightmap.ts` - убрать автоматическую инициализацию, добавить проверки
2. `src/client/noiseGenerator.ts` - проверить логику инициализации (возможно, не требует изменений)

## Критические места
- Строка 181-187 в `tartuHeightmap.ts`: функция `getTartuHeight()` с автоматической инициализацией
- Строка 205-212 в `noiseGenerator.ts`: инициализация кэша только для Тартарии
- Строка 389-397 в `noiseGenerator.ts`: использование `getTartuHeight()` только при проверке `mapType === "tartaria"`

## Альтернативный подход (если первый не сработает)
Если проблема не в автоматической инициализации, возможно, нужно:
- Добавить проверку `mapType` внутри `getTartuHeight()` (но это нарушит разделение ответственности)
- Очищать кэш при dispose ChunkSystem, если новая карта не Тартария
- Добавить параметр `mapType` в `getTartuHeight()` для дополнительной проверки

